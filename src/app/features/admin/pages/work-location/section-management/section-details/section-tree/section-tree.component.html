<div class="tree-container" dir="ltr">
  <!-- Title and controls -->
  <div class="text-center">
    <!-- Search & Zoom Controls -->
    <div
      class="d-flex flex-wrap justify-content-center align-items-center gap-5 mb-4"
    >
      <!-- Search Controls -->
      <div class="search-controls">
        <div class="input-group search-input-group">
          <span class="input-group-text">
            <fa-icon [icon]="faSearch"></fa-icon>
          </span>
          <input
            type="text"
            class="form-control"
            placeholder="Search nodes..."
            [(ngModel)]="searchQuery"
            (input)="onSearchInput()"
          />
          <button
            class="btn btn-outline-secondary"
            (click)="clearSearch()"
            [disabled]="!searchQuery"
          >
            Clear
          </button>
        </div>
      </div>

      <!-- Zoom Controls -->
      <div class="zoom-controls d-flex align-items-center">
        <button
          (click)="zoomOut()"
          class="btn btn-outline-secondary btn-sm"
          [disabled]="zoomLevel <= minZoom"
          title="Zoom Out"
        >
          <fa-icon [icon]="faSearchMinus"></fa-icon> Zoom Out
        </button>

        <div class="zoom-level-display mx-2">
          <span class="zoom-percentage">{{ zoomLevel }}%</span>
        </div>

        <button
          (click)="zoomIn()"
          class="btn btn-outline-secondary btn-sm"
          [disabled]="zoomLevel >= maxZoom"
          title="Zoom In"
        >
          <fa-icon [icon]="faSearchPlus"></fa-icon> Zoom In
        </button>

        <button
          (click)="resetZoom()"
          class="btn btn-outline-secondary btn-sm ms-2"
          [disabled]="zoomLevel === 70"
          title="Reset Zoom"
        >
          <fa-icon [icon]="faSyncAlt"></fa-icon> Reset
        </button>
      </div>
    </div>
  </div>

  <!-- Tree Wrapper -->
  <div
    class="tree-wrapper"
    #treeWrapper
    (mousedown)="startDrag($event)"
    (mousemove)="onDrag($event)"
    (mouseup)="endDrag()"
    (mouseleave)="endDrag()"
  >
    <div
      class="tree"
      [style.transform]="'scale(' + zoomLevel / 100 + ')'"
      style="transform-origin: top center"
      [style.cursor]="
        isDragging ? 'grabbing' : zoomLevel > 100 ? 'grab' : 'default'
      "
    >
      <ul>
        @for (section of treeData; track section) {
        <li>
          <a
            class="tree-node section-node"
            [class.highlight-match]="isMatch(section)"
            [class.pulse]="shouldPulse(section)"
          >
            <i class="fas fa-th-large node-icon"></i>
            <span class="node-content">{{ section.name }}</span>
            @if (isMatch(section)) {
            <span class="match-badge">Match</span>
            }
          </a>
          @if (section.points?.length) {
          <ul>
            @for (point of section.points; track point) {
            <li>
              <a
                (click)="navigateToPoint(point.id)"
                class="tree-node point-node"
                [class.highlight-match]="isMatch(point)"
                [class.pulse]="shouldPulse(point)"
              >
                <i class="fas fa-map-marker-alt node-icon"></i>
                <span class="node-content">{{ point.name }}</span>
                @if (isMatch(point)) {
                <span class="match-badge">Match</span>
                }
              </a>

              <!-- Devices Layer -->
              @if (point.device && getRolePath() === 'admin') {
              <ul class="child-nodes device-nodes">
                <li>
                  <a
                    (click)="navigateToSensor(point.device.id)"
                    class="tree-node device-node"
                    [class.highlight-match]="isMatch(point.device)"
                    [class.pulse]="shouldPulse(point.device)"
                  >
                    <i class="fas fa-microchip node-icon"></i>
                    <span class="node-content">{{ point.device.name }}</span>
                    @if (isMatch(point.device)) {
                    <span class="match-badge">Match</span>
                    }
                  </a>
                </li>
              </ul>
              }
            </li>
            }
          </ul>
          }
        </li>
        }
      </ul>
    </div>
  </div>
</div>
