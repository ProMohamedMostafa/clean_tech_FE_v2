<div class="tree-container" dir="ltr">
  <div class="text-center">
    <!-- Controls Container -->
    <div class="controls-container">
      <!-- Search Controls -->
      <div class="search-controls">
        <div class="input-group search-input-group">
          <span class="input-group-text search-icon">
            <i class="fas fa-search"></i>
          </span>
          <input
            type="text"
            class="form-control search-input"
            [placeholder]="
              'DETAILS.STRUCTURE_EXPLORER.SEARCH_PLACEHOLDER' | translate
            "
            [(ngModel)]="searchQuery"
            (input)="onSearchInput()"
          />
          <button
            class="btn btn-clear"
            (click)="clearSearch()"
            [disabled]="!searchQuery"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>

      <!-- Zoom Controls -->
      <div class="zoom-controls">
        <button
          (click)="zoomOut()"
          class="btn btn-zoom"
          [title]="'DETAILS.STRUCTURE_EXPLORER.ZOOM_OUT' | translate"
          [disabled]="zoomLevel <= minZoom"
        >
          <i class="fas fa-search-minus"></i>
        </button>

        <div class="zoom-level-display">
          <span class="zoom-percentage">{{ zoomLevel }}%</span>
        </div>

        <button
          (click)="zoomIn()"
          class="btn btn-zoom"
          [title]="'DETAILS.STRUCTURE_EXPLORER.ZOOM_IN' | translate"
          [disabled]="zoomLevel >= maxZoom"
        >
          <i class="fas fa-search-plus"></i>
        </button>

        <button
          (click)="resetZoom()"
          class="btn btn-reset"
          [title]="'DETAILS.STRUCTURE_EXPLORER.RESET_ZOOM' | translate"
          [disabled]="zoomLevel === 70"
        >
          <i class="fas fa-undo"></i>
        </button>
      </div>
    </div>
  </div>

  <div
    class="tree-wrapper"
    #treeWrapper
    (mousedown)="startDrag($event)"
    (mousemove)="onDrag($event)"
    (mouseup)="endDrag()"
    (mouseleave)="endDrag()"
  >
    <div
      class="tree"
      [style.transform]="'scale(' + zoomLevel / 100 + ')'"
      [style.transform-origin]="'top center'"
      [style.cursor]="
        isDragging ? 'grabbing' : zoomLevel > 100 ? 'grab' : 'default'
      "
    >
      <ul>
        @for (area of treeData; track area) {
        <li>
          <a
            (click)="navigateToArea(area.id)"
            class="tree-node area-node"
            [class.highlight-match]="isMatch(area)"
            [class.pulse]="shouldPulse(area)"
          >
            <i class="fas fa-globe-americas node-icon"></i>
            <span class="node-content">{{ area.name }}</span>
            @if (isMatch(area)) {
            <span class="match-badge">Match</span>
            }
          </a>
          @if (area.cities?.length) {
          <ul>
            @for (city of area.cities; track city) {
            <li>
              <a
                (click)="navigateToCity(city.id)"
                class="tree-node city-node"
                [class.highlight-match]="isMatch(city)"
                [class.pulse]="shouldPulse(city)"
              >
                <i class="fas fa-city node-icon"></i>
                <span class="node-content">{{ city.name }}</span>
                @if (isMatch(city)) {
                <span class="match-badge">Match</span>
                }
              </a>
              @if (city.organizations?.length) {
              <ul>
                @for (org of city.organizations; track org) {
                <li>
                  <a
                    (click)="navigateToOrganization(org.id)"
                    class="tree-node org-node"
                    [class.highlight-match]="isMatch(org)"
                    [class.pulse]="shouldPulse(org)"
                  >
                    <i class="fas fa-building node-icon"></i>
                    <span class="node-content">{{ org.name }}</span>
                    @if (isMatch(org)) {
                    <span class="match-badge">Match</span>
                    }
                  </a>
                  @if (org.buildings?.length) {
                  <ul>
                    @for (building of org.buildings; track building) {
                    <li>
                      <a
                        (click)="navigateToBuilding(building.id)"
                        class="tree-node building-node"
                        [class.highlight-match]="isMatch(building)"
                        [class.pulse]="shouldPulse(building)"
                      >
                        <i class="fas fa-hotel node-icon"></i>
                        <span class="node-content">{{ building.name }}</span>
                        @if (isMatch(building)) {
                        <span class="match-badge">Match</span>
                        }
                      </a>
                      @if (building.floors?.length) {
                      <ul>
                        @for (floor of building.floors; track floor) {
                        <li>
                          <a
                            (click)="navigateToFloor(floor.id)"
                            class="tree-node floor-node"
                            [class.highlight-match]="isMatch(floor)"
                            [class.pulse]="shouldPulse(floor)"
                          >
                            <i class="fas fa-layer-group node-icon"></i>
                            <span class="node-content">{{ floor.name }}</span>
                            @if (isMatch(floor)) {
                            <span class="match-badge">Match</span>
                            }
                          </a>
                          @if (floor.sections?.length) {
                          <ul>
                            @for (section of floor.sections; track section) {
                            <li>
                              <a
                                (click)="navigateToSection(section.id)"
                                class="tree-node section-node"
                                [class.highlight-match]="isMatch(section)"
                                [class.pulse]="shouldPulse(section)"
                              >
                                <i class="fas fa-th-large node-icon"></i>
                                <span class="node-content">{{
                                  section.name
                                }}</span>
                                @if (isMatch(section)) {
                                <span class="match-badge">Match</span>
                                }
                              </a>
                              @if (section.points?.length) {
                              <ul>
                                @for (point of section.points; track point) {
                                <li>
                                  <a
                                    (click)="navigateToPoint(point.id)"
                                    class="tree-node point-node"
                                    [class.highlight-match]="isMatch(point)"
                                    [class.pulse]="shouldPulse(point)"
                                  >
                                    <i
                                      class="fas fa-map-marker-alt node-icon"
                                    ></i>
                                    <span class="node-content">{{
                                      point.name
                                    }}</span>
                                    @if (isMatch(point)) {
                                    <span class="match-badge">Match</span>
                                    }
                                  </a>

                                  <!-- Devices Layer -->
                                  @if (point.device && getRolePath() ===
                                  'admin') {
                                  <ul class="child-nodes device-nodes">
                                    <li>
                                      <a
                                        (click)="
                                          navigateToSensor(point.device.id)
                                        "
                                        class="tree-node device-node"
                                        [class.highlight-match]="
                                          isMatch(point.device)
                                        "
                                        [class.pulse]="
                                          shouldPulse(point.device)
                                        "
                                      >
                                        <i
                                          class="fas fa-microchip node-icon"
                                        ></i>
                                        <span class="node-content">{{
                                          point.device.name
                                        }}</span>
                                        @if (isMatch(point.device)) {
                                        <span class="match-badge">Match</span>
                                        }
                                      </a>
                                    </li>
                                  </ul>
                                  }
                                </li>
                                }
                              </ul>
                              }
                            </li>
                            }
                          </ul>
                          }
                        </li>
                        }
                      </ul>
                      }
                    </li>
                    }
                  </ul>
                  }
                </li>
                }
              </ul>
              }
            </li>
            }
          </ul>
          }
        </li>
        }
      </ul>
    </div>
  </div>
</div>
